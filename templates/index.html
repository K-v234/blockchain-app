<!-- ShadowChain V4 - index.html (Frontend) -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ShadowChain V4</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="/static/elliptic.min.js"></script>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <style>
    body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
    .card { background-color: #1e293b; border-radius: 12px; padding: 20px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); }
  </style>
</head>
<body class="p-6">
  <h1 class="text-4xl mb-6 font-bold text-yellow-400 text-center">⚡ ShadowChain V4 Wallet & Explorer</h1>

  <div class="card">
    <h2 class="text-2xl mb-2 text-yellow-300">🧠 Create Wallet</h2>
    <button id="createWalletBtn" class="bg-yellow-400 px-4 py-2 rounded text-black">Generate Wallet</button>
    <div id="walletInfo" class="mt-4 hidden">
      <p>Address: <span id="walletAddress" class="text-green-300"></span></p>
      <p>Balance: <span id="walletBalance" class="text-blue-400"></span> SHD</p>
      <p><a id="downloadKey" href="#" class="text-yellow-200 underline">Download Private Key</a></p>
      <p><a id="downloadQR" href="#" class="text-yellow-200 underline">Download QR Code</a></p>
    </div>
  </div>

  <div class="card hidden" id="sendCard">
    <h2 class="text-2xl mb-2 text-yellow-300">💸 Send Transaction</h2>
    <input type="text" id="recipient" placeholder="Recipient Address" class="w-full p-2 mb-2 rounded bg-gray-700" />
    <input type="number" id="amount" placeholder="Amount" class="w-full p-2 mb-2 rounded bg-gray-700" />
    <textarea id="privateKeyInput" placeholder="Paste your private key (PEM)" rows="4" class="w-full p-2 mb-2 rounded bg-gray-700"></textarea>
    <button id="sendTxBtn" class="bg-yellow-400 px-4 py-2 rounded text-black">Send</button>
  </div>

  <div class="card hidden" id="mineCard">
    <h2 class="text-2xl mb-2 text-yellow-300">⛏️ Mine SHD</h2>
    <input type="text" id="minerAddress" readonly class="w-full p-2 mb-2 rounded bg-gray-700" />
    <button id="mineBtn" class="bg-yellow-400 px-4 py-2 rounded text-black">Mine Block</button>
  </div>

  <div class="card">
    <h2 class="text-2xl text-yellow-300">🔍 Blockchain Explorer</h2>
    <div id="chainExplorer" class="mt-4 max-h-[300px] overflow-y-scroll"></div>
  </div>

  <div class="card">
    <h2 class="text-2xl text-yellow-300">🏆 Leaderboard</h2>
    <div id="leaderboard" class="mt-4"></div>
  </div>

  <div class="card">
    <h2 class="text-2xl text-yellow-300">📊 Tokenomics</h2>
    <div id="tokenomicsStats" class="mt-4"></div>
  </div>

  <script>
    const EC = elliptic.ec;
    const ec = new EC('secp256k1');
    const socket = io();

    let currentAddress = null;

    document.getElementById('createWalletBtn').onclick = async () => {
      const res = await fetch('/wallet/new');
      const data = await res.json();
      currentAddress = data.address;
      document.getElementById('walletAddress').textContent = data.address;
      document.getElementById('walletBalance').textContent = 'Loading...';
      document.getElementById('walletInfo').classList.remove('hidden');
      document.getElementById('sendCard').classList.remove('hidden');
      document.getElementById('mineCard').classList.remove('hidden');
      document.getElementById('minerAddress').value = data.address;
      document.getElementById('downloadKey').href = `/wallet/key/${data.address}`;
      document.getElementById('downloadQR').href = `/wallet/qr/${data.address}`;

      const bal = await fetch(`/balance/${data.address}`);
      const balData = await bal.json();
      document.getElementById('walletBalance').textContent = balData.balance.toFixed(4);
    };

    document.getElementById('sendTxBtn').onclick = async () => {
      const recipient = document.getElementById('recipient').value;
      const amount = parseFloat(document.getElementById('amount').value);
      const privKeyPEM = document.getElementById('privateKeyInput').value;
      if (!recipient || isNaN(amount) || !privKeyPEM) return Swal.fire('❌ All fields required');

      const utxos = await (await fetch(`/utxos/${currentAddress}`)).json();
      if (!utxos.length) return Swal.fire('❌ No UTXOs');
      const utxo = utxos[0];

      // fake for now:
      const tx = {
        vin: [{ txid: utxo.txid, vout: utxo.vout, signature: "fake", pubkey: "fake" }],
        vout: [
          { amount, address: recipient },
          { amount: utxo.amount - amount, address: currentAddress }
        ]
      };

      const res = await fetch('/transaction/send', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(tx)
      });
      const json = await res.json();
      Swal.fire(res.ok ? `✅ TXID: ${json.txid}` : `❌ ${json.error}`);
    };

    document.getElementById('mineBtn').onclick = async () => {
      const res = await fetch('/mine', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ miner_address: currentAddress })
      });
      const json = await res.json();
      Swal.fire(json.message);
    };

    async function refreshExplorer() {
      const res = await fetch('/chain');
      const data = await res.json();
      const explorer = document.getElementById('chainExplorer');
      explorer.innerHTML = data.chain.slice(-10).reverse().map(b => `
        <div class="bg-gray-700 p-2 rounded mb-2">
          <b>#${b.index}</b> | <span class="text-green-300">${b.hash.slice(0, 18)}...</span>
          <div class="text-sm text-gray-300">TXs: ${b.transactions.length} | Nonce: ${b.nonce}</div>
        </div>
      `).join('');
    }

    async function refreshLeaderboard() {
      const res = await fetch('/leaderboard');
      const data = await res.json();
      document.getElementById('leaderboard').innerHTML = data.map(e => `<div>${e.address}: ${e.mined.toFixed(2)} SHD</div>`).join('');
    }

    async function refreshTokenomics() {
      const res = await fetch('/tokenomics');
      const d = await res.json();
      document.getElementById('tokenomicsStats').innerHTML = `
        Total Mined: ${d.total_mined}<br>
        Remaining: ${d.remaining_supply}<br>
        Reward: ${d.block_reward} SHD<br>
        Block Height: ${d.current_height}
      `;
    }

    socket.on('new_block', (data) => {
      refreshExplorer();
      refreshLeaderboard();
      refreshTokenomics();
    });

    refreshExplorer();
    refreshLeaderboard();
    refreshTokenomics();
  </script>
</body>
</html>
